<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Life Expectancy Narrative Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      text-align: center;
    }

    .scene-container {
      margin-top: 20px;
    }

    svg {
      margin-top: 20px;
    }

    .nav-buttons {
      margin: 20px;
    }

    .annotation {
      margin-top: 10px;
      font-size: 1em;
      font-style: italic;
    }

    .dropdown-container {
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h1>Global Life Expectancy Trends</h1>
  <div class="scene-container">
    <div id="chart"></div>
    <div class="annotation" id="annotation"></div>
  </div>

  <div class="nav-buttons">
    <button onclick="prevScene()">Previous</button>
    <button onclick="nextScene()">Next</button>
  </div>

  <script>
    const width = 800, height = 400, margin = { top: 50, right: 50, bottom: 50, left: 50 };

    let data = [];
  
    d3.csv("life_expectancy.csv", function(d) {
      return {
        Country: d["Country"]?.trim(),
        Year: +d["Year"],
        LifeExpectancy: +d["Life_expectancy"], 
        Status: d["Status"]?.trim() || "Unknown"
      };
    }).then(function(parsed) {
      data = parsed.filter(d =>
        d.Country && !isNaN(d.Year) && !isNaN(d.LifeExpectancy)
      );
    });

    let scene = 0;

    function drawScene() {
      d3.select("#chart").html(""); // Clear previous content
      d3.select("#annotation").text(""); // Clear annotation

      if (scene === 0) {
        drawScene1();
      } else if (scene === 1) {
        drawScene2();
      } else if (scene === 2) {
        drawScene3();
      }
    }

    function drawScene1() {
      const yearly = d3.rollup(data, v => d3.mean(v, d => d.LifeExpectancy), d => d.Year);
      const processed = Array.from(yearly, ([Year, LifeExpectancy]) => ({ Year, LifeExpectancy }));

      drawLineChart(processed, "Global Average Life Expectancy", "Year", "LifeExpectancy");
      d3.select("#annotation").text("Scene 1: Life expectancy global avg");
    }

    function drawScene2() {
      const nested = d3.rollups(data,
        v => d3.mean(v, d => d.LifeExpectancy),
        d => d.Status,
        d => d.Year
      );

      const lines = nested.map(([status, values]) => ({
        name: status,
        values: values.map(([Year, LifeExpectancy]) => ({ Year, LifeExpectancy }))
      }));

      const svg = createSvg();

      const allYears = Array.from(new Set(data.map(d => d.Year))).sort();
      const x = d3.scaleLinear().domain(d3.extent(allYears)).range([margin.left, width - margin.right]);
      const y = d3.scaleLinear().domain([50, 85]).range([height - margin.bottom, margin.top]);

      svg.append("g").attr("transform", `translate(0,${height - margin.bottom})`).call(d3.axisBottom(x).ticks(5));
      svg.append("g").attr("transform", `translate(${margin.left},0)`).call(d3.axisLeft(y));

      const line = d3.line().x(d => x(d.Year)).y(d => y(d.LifeExpectancy));

      svg.selectAll(".line")
        .data(lines)
        .join("path")
        .attr("fill", "none")
        .attr("stroke", d => d.name === "Developed" ? "steelblue" : "green")
        .attr("stroke-width", 2)
        .attr("d", d => line(d.values));

      svg.selectAll(".label")
        .data(lines)
        .enter()
        .append("text")
        .attr("x", width - 100)
        .attr("y", (d, i) => margin.top + i * 20)
        .text(d => d.name)
        .attr("fill", d => d.name === "Developed" ? "steelblue" : "green");

      d3.select("#annotation").text("Scene 2: Developed vs Developing Countries avg Life Expectancy");
    }

    function drawScene3() {
      const svg = createSvg();

      const countries = Array.from(new Set(data.map(d => d.Country))).sort();
      const dropdown = d3.select("#chart").append("div")
        .attr("class", "dropdown-container")
        .append("select")
        .on("change", function () {
          updateCountryChart(this.value);
        });

      dropdown.selectAll("option")
        .data(countries)
        .enter()
        .append("option")
        .text(d => d)
        .attr("value", d => d);

      // Initial country
      updateCountryChart(countries[0]);
      d3.select("#annotation").text("Scene 3: Select a country to explore its life expectancy trend.");

      function updateCountryChart(country) {
        svg.selectAll("*").remove(); // Clear previous

        const countryData = data.filter(d => d.Country === country);

        const x = d3.scaleLinear()
          .domain(d3.extent(countryData, d => d.Year))
          .range([margin.left, width - margin.right]);

        const y = d3.scaleLinear()
          .domain([d3.min(countryData, d => d.LifeExpectancy) - 2, d3.max(countryData, d => d.LifeExpectancy) + 2])
          .range([height - margin.bottom, margin.top]);

        svg.append("g")
          .attr("transform", `translate(0,${height - margin.bottom})`)
          .call(d3.axisBottom(x).ticks(5));

        svg.append("g")
          .attr("transform", `translate(${margin.left},0)`)
          .call(d3.axisLeft(y));

        const line = d3.line()
          .x(d => x(d.Year))
          .y(d => y(d.LifeExpectancy));

        svg.append("path")
          .datum(countryData)
          .attr("fill", "none")
          .attr("stroke", "purple")
          .attr("stroke-width", 2)
          .attr("d", line);
      }
    }

    function createSvg() {
      return d3.select("#chart")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    }

    function drawLineChart(data, title, xKey, yKey) {
      const svg = createSvg();

      const x = d3.scaleLinear()
        .domain(d3.extent(data, d => d[xKey]))
        .range([margin.left, width - margin.right]);

      const y = d3.scaleLinear()
        .domain([d3.min(data, d => d[yKey]) - 2, d3.max(data, d => d[yKey]) + 2])
        .range([height - margin.bottom, margin.top]);

      svg.append("g")
        .attr("transform", `translate(0,${height - margin.bottom})`)
        .call(d3.axisBottom(x).ticks(5));

      svg.append("g")
        .attr("transform", `translate(${margin.left},0)`)
        .call(d3.axisLeft(y));

      const line = d3.line()
        .x(d => x(d[xKey]))
        .y(d => y(d[yKey]));

      svg.append("path")
        .datum(data)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 2)
        .attr("d", line);
    }

    function prevScene() {
      scene = (scene + 2) % 3;
      drawScene();
    }

    function nextScene() {
      scene = (scene + 1) % 3;
      drawScene();
    }

    drawScene(); // Initial draw
  </script>
</body>
</html>
